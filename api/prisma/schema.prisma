// Prisma Schema para fidufi
// Base de datos: PostgreSQL

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // La URL de conexión ahora se configura en prisma.config.ts
}

// Roles de actores en el sistema
enum ActorRole {
  SUPER_ADMIN // Superusuario - puede hacer todo, gestionar usuarios y reglas
  FIDUCIARIO // Reporta activos, recibe alertas
  COMITE_TECNICO // Aprueba excepciones, modifica reglas
  AUDITOR // Solo lectura, consulta historial
  REGULADOR // Solo lectura, verifica cumplimiento
  BENEFICIARIO // Fideicomisario - solo lectura, recibe alertas sobre sus fideicomisos
}

// Tipos de activos según el contrato
enum AssetType {
  GovernmentBond // Bonos federales o instrumentos de renta fija
  MortgageLoan // Préstamos hipotecarios
  InsuranceReserve // Reservas de seguros
  CNBVApproved // Valores aprobados por CNBV
  SocialHousing // Vivienda social
}

// Estado de cumplimiento de un activo
enum ComplianceStatus {
  COMPLIANT // Cumple todas las reglas
  NON_COMPLIANT // No cumple alguna regla
  PENDING_REVIEW // Requiere revisión del Comité Técnico
  EXCEPTION_APPROVED // Excepción aprobada por Comité Técnico
}

// Estado del fideicomiso [AUTO]: arranca en DRAFT
enum TrustStatus {
  DRAFT    // Borrador (onboarding en curso)
  ACTIVO   // En operación
  CERRADO   // Finalizado
}

// Tipo/plantilla de fideicomiso: define reglas y atributos por categoría
// [ONBOARDING]: se elige al crear el fideicomiso
model TrustType {
  id          String   @id @default(uuid())
  code        String   @unique // CONSTRUCCION | FINANCIERO | ADMINISTRATIVO
  name        String   // "Construcción", "Financiero (Inversión)", "Administrativo"
  description String?
  // Reglas y atributos requeridos por tipo (JSON)
  // Construcción: { presupuestoTotalRequired: true, requiresMilestones: true, ... }
  // Financiero: { bondLimitPercent, otherLimitPercent, initialCapitalRequired: true }
  // Administrativo: { ... }
  rulesConfig Json     @default("{}")
  // Campos ONBOARDING para este tipo (opcional, para validación en UI)
  onboardingFieldsSchema Json? @default("[]")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trusts      Trust[]

  @@index([code])
  @@index([isActive])
}

// Actor del sistema (Fiduciario, Comité Técnico, Auditor, Regulador, Super Admin)
model Actor {
  id           String    @id @default(uuid())
  name         String?
  email        String?   @unique // Email para autenticación
  passwordHash String? // Hash de contraseña (bcrypt)
  role         ActorRole
  isSuperAdmin Boolean   @default(false) // Flag para superusuario (no puede ser eliminado)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Identidad principal (SSI) - Opcional
  primaryDid String? @unique

  // Identidades alternativas (fallbacks) - Opcionales
  ethereumAddress   String? @unique
  polkadotAccountId String? @unique
  ensName           String?

  // Proof of Personhood (almacenado como JSON)
  popCredentials Json?

  // Relaciones
  registeredAssets      Asset[]
  beneficiaryAssets     Asset[]            @relation("BeneficiaryAssets") // Activos asociados como beneficiario
  alerts                Alert[]
  ruleModifications     RuleModification[]
  trustMemberships      ActorTrust[] // Pertenencia a fideicomisos
  auditLogs             AuditLog[] // Logs de auditoría
  exceptionVotes        ExceptionVote[]    @relation("ExceptionVotes") // Votaciones de excepciones
  createdAssetTemplates AssetTemplate[] // Plantillas de activos creadas por este actor

  @@index([primaryDid])
  @@index([ethereumAddress])
  @@index([email])
  @@index([role])
  @@index([isSuperAdmin])
}

// Activo registrado en el fideicomiso
model Asset {
  id        String    @id @default(uuid())
  trustId   String // ID del fideicomiso (ej. "10045")
  assetType AssetType
  valueMxn  Decimal   @db.Decimal(18, 2) // Monto en MXN

  // Metadatos del activo
  description  String?
  documentHash String? // Hash del documento PDF adjunto
  registeredAt DateTime @default(now())

  // Estado de cumplimiento
  complianceStatus ComplianceStatus
  compliant        Boolean // true si cumple todas las reglas

  // Validación de reglas (almacenado como JSON para flexibilidad)
  validationResults Json? // Resultados detallados de cada regla

  // Evidencia blockchain
  vcHash            String? // Hash del Verifiable Credential
  blockchainTxHash  String? // Hash de la transacción en blockchain
  blockchainNetwork String? // Red utilizada (ej. "polygon-zkevm")
  anchoredAt        DateTime?

  // Actor que registró el activo
  registeredBy String // Actor.id
  actor        Actor  @relation(fields: [registeredBy], references: [id])

  // Beneficiario asociado (opcional, para préstamos hipotecarios y vivienda social)
  beneficiaryId String? // Actor.id del beneficiario (solo si aplica)
  beneficiary   Actor?  @relation("BeneficiaryAssets", fields: [beneficiaryId], references: [id])

  // Relaciones
  alerts         Alert[]
  exceptionVotes ExceptionVote[] // Votaciones de excepciones para este activo

  @@index([trustId])
  @@index([assetType])
  @@index([registeredBy])
  @@index([beneficiaryId])
  @@index([complianceStatus])
  @@index([registeredAt])
}

// Alertas generadas por incumplimiento y eventos del sistema
model Alert {
  id      String  @id @default(uuid())
  assetId String? // Opcional para alertas no relacionadas con activos específicos
  asset   Asset?  @relation(fields: [assetId], references: [id])

  actorId String // Actor que debe recibir la alerta
  actor   Actor  @relation(fields: [actorId], references: [id])

  message  String
  severity String // "warning", "error", "info", "critical"

  // Campos para alertas avanzadas
  alertType    String? // "EXPIRATION", "PAYMENT", "COMPLIANCE", "MEETING", "DOCUMENT"
  alertSubtype String? // Subtipo específico (ej. "BOND_MATURITY", "FIDUCIARIO_FEE_DUE")
  metadata     Json? // Datos adicionales específicos del tipo de alerta

  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?

  createdAt DateTime @default(now())

  @@index([assetId])
  @@index([actorId])
  @@index([acknowledged])
  @@index([alertType])
  @@index([alertSubtype])
}

// Modificaciones de reglas por el Comité Técnico
model RuleModification {
  id            String  @id @default(uuid())
  trustId       String
  ruleName      String // Nombre de la regla modificada
  previousValue Json? // Valor anterior
  newValue      Json // Nuevo valor
  reason        String?

  approvedBy String // Actor.id del miembro del Comité que aprobó
  actor      Actor  @relation(fields: [approvedBy], references: [id])

  createdAt DateTime @default(now())

  @@index([trustId])
  @@index([approvedBy])
}

// Configuración de fideicomiso
model Trust {
  id      String  @id @default(uuid())
  trustId String  @unique // ID del contrato (ej. "10045") [AUTO]
  name    String? // nombre / denominación [ONBOARDING]

  // --- Plantilla de tipo de fideicomiso [ONBOARDING] ---
  trustTypeId   String?   // FK a TrustType (Construcción, Financiero, Administrativo)
  trustTypeRef  TrustType? @relation(fields: [trustTypeId], references: [id], onDelete: SetNull)
  trustType     String?   @default("INVESTMENT") // Legacy: 'INVESTMENT' | 'CONDOMINIUM' (mapear desde TrustType si aplica)
  // Valores tipo-específicos: construcción → presupuestoTotal; financiero → límites ya en Trust
  trustTypeConfig Json?   @default("{}") // ej. { "presupuestoTotal": 1000000 } para CONSTRUCCION

  // Estado [AUTO]: arranca en DRAFT
  status   TrustStatus @default(DRAFT) // DRAFT | ACTIVO | CERRADO

  // Patrimonio inicial (financiero/inversión)
  initialCapital Decimal @db.Decimal(18, 2)

  // Límites de inversión (solo tipo FINANCIERO; null para Construcción/Administrativo)
  bondLimitPercent  Decimal? @db.Decimal(5, 2) // 30% para bonos (solo inversión)
  otherLimitPercent Decimal? @db.Decimal(5, 2) // 70% para otros (solo inversión)

  // Información de partes involucradas
  fideicomitenteName String? // Nombre del fideicomitente (quien aporta los bienes)
  fideicomitenteRFC  String? // RFC del fideicomitente
  fiduciarioName     String? // Nombre de la institución fiduciaria (banco)
  fiduciarioRFC      String? // RFC del fiduciario

  // --- Identificación y firma [ONBOARDING] ---
  fechaFirma       DateTime? // fecha_firma
  lugarFirma       String?   // lugar_firma
  jurisdiccion     String?   // tribunales_competentes
  domicilioLegal   String?   // domicilio_legal
  domicilioFiscal  String?   // domicilio_fiscal
  baseCurrency     String?   @default("ARS") // moneda_base (ARS/USD/MXN) para reportes
  fechaCierreEjercicioDay   Int? // día cierre (1-31), ej. 31 para 31/12
  fechaCierreEjercicioMonth Int? // mes cierre (1-12)

  // Plazos y vigencia
  constitutionDate DateTime? // Fecha de constitución del contrato
  expirationDate   DateTime? // Fecha de vencimiento calculada
  maxTermYears     Int? // plazo_maximo en años (30, 50, 70)
  termType         String? // 'STANDARD' (30 años), 'FOREIGN' (50 años), 'DISABILITY' (70 años)
  fechaObjetivoEntrega DateTime? // fecha_objetivo_entrega (si el contrato la fija)
  reglasExtincionResumen String? @db.Text // resumen operativo de extinción [ONBOARDING]

  // --- Objeto y alcance [ONBOARDING] ---
  objetoTexto        String?   @db.Text // objeto del fideicomiso (o custom)
  finalidadCategoria String?   // obra/PH/adjudicación; inversión; administración
  anexosObligatorios Json?    @default("[]") // checklist: Anexo I, II, III (los archivos en Documentos)

  // --- Reglas operativas [ONBOARDING] ---
  requiresConsensus Boolean @default(false) // Si true, excepciones requieren mayoría (2 de 3)
  reportPeriodicity   String?  @default("MONTHLY") // politica_rendicion: 'MONTHLY' | 'QUARTERLY' | 'ANNUAL'
  fiscalYearEndMonth  Int?     // Mes de cierre (1-12), ej. 12 para 31/12
  fiscalYearEndDay    Int?     // Día de cierre (1-31)
  observationDays     Int?     // ventana_objecion_dias (politica_rendicion)
  moraAutomatica     Boolean  @default(false) // politica_mora
  diasGracia         Int?     // días de gracia antes de mora
  permisosPortal     Json?    @default("{}") // beneficiarios ven: aportes/gastos/reportes/obra

  // --- Metadatos [POST] ---
  tags           String[] @default([]) // inmobiliario, condominio, etapa1, etc.
  notasInternas   String?  @db.Text

  // Obligaciones fiscales
  rfc                   String? // RFC del fideicomiso
  satRegistrationNumber String? // Número de registro ante SAT
  satRegisteredAt       DateTime? // Fecha de registro ante SAT

  // Finalización
  terminationDate       DateTime?
  terminationType       String? // 'EXPIRATION', 'CONDITION_MET', 'EARLY_TERMINATION'
  terminationReason     String?
  transmissionCompleted Boolean   @default(false)

  // Relaciones
  fiduciarioFee     FiduciarioFee?
  members           ActorTrust[] // Usuarios asignados a este fideicomiso
  comiteSessions    ComiteSession[] // Sesiones del Comité Técnico
  monthlyStatements MonthlyStatement[] // Estados de cuenta mensuales
  exceptionVotes    ExceptionVote[] // Votaciones de excepciones

  // Estado
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  assetTemplates AssetTemplate[]

  // Iteración 1: Core Condominios / trazabilidad
  contributions      Contribution[]
  budgetItems        BudgetItem[]
  cashflowPlans      CashflowPlan[]
  expenses           Expense[]
  fiduciaryAccounts  FiduciaryAccount[]
  contractDocuments  ContractDocument[]
  insurancePolicies  InsurancePolicy[]
  checklistItems     ChecklistItem[]
  trustConcepts      TrustConcept[]
  // Iteración 3: Obra e hitos
  milestones         Milestone[]
  // Iteración 4: Policy engine
  approvalPolicies   ApprovalPolicy[]
  approvalRequests   ApprovalRequest[]
  // Iteración 5: Unidades funcionales
  units               Unit[]
  unitSelectionRounds UnitSelectionRound[]
  saleProcesses       SaleProcess[]

  @@index([trustId])
  @@index([expirationDate])
  @@index([active])
  @@index([trustType])
  @@index([trustTypeId])
  @@index([status])
}

// --- Iteración 1: Aportes y bienes ---
enum ContributionType {
  MONEY
  GOOD
  SERVICE
}

enum ContributionStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model Contribution {
  id          String            @id @default(uuid())
  trustId     String
  trust       Trust             @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  contributorId String?          // Actor.id del aportante (opcional si es genérico)
  concept     String            // Concepto del aporte
  amount      Decimal           @db.Decimal(18, 2)
  currency    String            @default("MXN") // ISO 4217
  contributionType ContributionType @default(MONEY)
  dueDate     DateTime          // Vencimiento
  paidAt      DateTime?
  status      ContributionStatus @default(PENDING)
  evidenceUrl String?            // URL del comprobante
  evidenceHash String?
  metadata    Json?              // Participación %, etc.

  // Mora e intimación (Iteración 2)
  intimacionSentAt    DateTime?  // Fecha de envío de intimación
  intimacionDocUrl    String?    // URL del documento de intimación enviado
  intimacionTemplate  String?    // Clave de plantilla usada (ej. "default_15_days")

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([trustId])
  @@index([contributorId])
  @@index([status])
  @@index([dueDate])
}

// --- Iteración 1: Presupuesto y flujo de fondos ---
model BudgetItem {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name        String   // Rubro (ej. "Obra civil", "Honorarios")
  code        String?  // Código opcional
  amount      Decimal  @db.Decimal(18, 2)
  currency    String   @default("MXN")
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  expenses    Expense[]

  @@index([trustId])
}

model CashflowPlan {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name        String   // Ej. "Plan desembolsos 2025"
  planType    String   // 'BY_MILESTONE' | 'BY_MONTH'
  schedule    Json     // [{ month?, milestoneId?, amount, dueDate }] o similar
  totalAmount Decimal  @db.Decimal(18, 2)
  currency    String   @default("MXN")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([trustId])
}

// --- Iteración 1: Gastos y cuentas ---
model Expense {
  id             String   @id @default(uuid())
  trustId        String
  trust          Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  budgetItemId   String?
  budgetItem     BudgetItem? @relation(fields: [budgetItemId], references: [id], onDelete: SetNull)
  milestoneId    String?   // Iteración 3: hito asociado (certificación de obra)
  milestone      Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  concept        String
  amount         Decimal  @db.Decimal(18, 2)
  currency       String   @default("MXN")
  expenseType    String?  // 'DIRECT_COST' | 'INDIRECT_COST' | 'TAX' | 'FIDUCIARY_FEE' | etc.
  paidAt         DateTime?
  fiduciaryAccountId String? // Cuenta de la que se pagó
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  supportingDocuments SupportingDocument[]

  @@index([trustId])
  @@index([budgetItemId])
  @@index([milestoneId])
  @@index([paidAt])
}

// Iteración 3: Hitos de obra (etapas, certificaciones, avance %)
model Milestone {
  id            String   @id @default(uuid())
  trustId       String
  trust         Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name          String   // Ej. "Etapa 1 - Cimentación", "Certificación 50%"
  description   String?
  dueDate       DateTime?
  completedAt   DateTime?
  progressPercent Int    @default(0) // 0-100
  evidenceUrl   String?
  evidenceHash  String?
  parentId      String?  // Hito padre (etapa contiene sub-hitros)
  parent        Milestone?  @relation("MilestoneHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Milestone[] @relation("MilestoneHierarchy")
  metadata      Json?    // Certificación, acta, etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  expenses      Expense[]

  @@index([trustId])
  @@index([parentId])
  @@index([dueDate])
}

// Iteración 4: Policy engine - reglas de aprobación por Trust y tipo de acción
model ApprovalPolicy {
  id           String   @id @default(uuid())
  trustId      String
  trust        Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  actionType   String   // APPROVE_EXPENSE, APPROVE_MILESTONE, APPROVE_PROJECT, EXCEPTION_ASSET, SELL_UNIT, etc.
  ruleType     String   // UNANIMOUS | MAJORITY | ROLE
  requiredRoles String[] // ActorRole cuando ruleType = ROLE
  deadlineDays Int?     // Plazo en días para responder
  silenceMeans String?  // APPROVE | REJECT | NEUTRAL
  documentationRequired Json? // Lista de documentos requeridos
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([trustId, actionType])
  @@index([trustId])
}

// Solicitud de aprobación genérica (entidad + tipo de acción)
model ApprovalRequest {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  actionType  String
  entityType  String   // Expense, Milestone, Asset, Unit, SaleProcess
  entityId    String
  status      String   @default("PENDING") // PENDING | APPROVED | REJECTED
  requestedBy String   // Actor.id
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?  // Actor.id

  votes       ApprovalVote[]

  @@index([trustId])
  @@index([entityType])
  @@index([entityId])
  @@index([status])
}

model ApprovalVote {
  id        String   @id @default(uuid())
  requestId String
  request   ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  voterId   String   // Actor.id
  vote      String   // APPROVE | REJECT
  reason    String?
  createdAt DateTime @default(now())

  @@unique([requestId, voterId])
  @@index([requestId])
  @@index([voterId])
}

// Iteración 5: Unidades funcionales (departamentos, cocheras)
enum UnitStatus {
  AVAILABLE
  RESERVED
  IN_MARKETING
  ASSIGNED
  ADJUDICATED
  CONVEYED
}

model Unit {
  id          String     @id @default(uuid())
  trustId     String
  trust       Trust      @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name        String     // Ej. "Depto 101", "Cochera A1"
  unitType    String?    // APARTMENT_1BR, APARTMENT_2BR, PARKING, etc.
  areaSqm     Decimal?   @db.Decimal(10, 2)
  status      UnitStatus @default(AVAILABLE)
  metadata    Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  allocations UnitAllocation[]

  @@index([trustId])
  @@index([status])
}

model UnitAllocation {
  id        String   @id @default(uuid())
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  actorId   String   // Beneficiario asignado
  roundId   String?  // Ronda en que se asignó
  allocatedAt DateTime @default(now())
  metadata  Json?

  @@unique([unitId])
  @@index([unitId])
  @@index([actorId])
}

model UnitSelectionRound {
  id        String   @id @default(uuid())
  trustId   String
  trust     Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name      String   // Ej. "Ronda 1 - Elección de unidades"
  roundType String   @default("ROTATING") // ROTATING | ALTERNATING | CUSTOM
  startedAt DateTime @default(now())
  completedAt DateTime?
  minutesUrl String?
  minutesHash String?
  metadata  Json?    // Orden de sorteo, acta
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trustId])
}

// Iteración 6: Comercialización / terceros adquirentes
model SaleProcess {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  unitId      String?  // Unidad en venta/cesión
  status      String   @default("PIPELINE") // PIPELINE | RESERVED | DUE_DILIGENCE | CLOSED
  buyerActorId String? // Tercero adquirente (Actor.id) cuando se cierra
  metadata    Json?    // Precio, condiciones
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations SaleReservation[]

  @@index([trustId])
  @@index([unitId])
  @@index([status])
}

model SaleReservation {
  id          String   @id @default(uuid())
  saleProcessId String
  saleProcess   SaleProcess @relation(fields: [saleProcessId], references: [id], onDelete: Cascade)
  interestedActorId String? // Actor.id del interesado
  contactEmail String?
  contactName  String?
  notes        String?
  createdAt    DateTime @default(now())

  @@index([saleProcessId])
}

model SupportingDocument {
  id        String   @id @default(uuid())
  expenseId String
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  documentUrl  String?
  documentHash String?
  docType   String?  // 'INVOICE' | 'CONTRACT' | 'RECEIPT'
  createdAt DateTime @default(now())

  @@index([expenseId])
}

model FiduciaryAccount {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  name        String   // Ej. "Cuenta fiduciaria principal"
  accountNumber String?
  bankName    String?
  currency    String   @default("MXN")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  movements   BankMovement[]

  @@index([trustId])
}

model BankMovement {
  id          String   @id @default(uuid())
  accountId   String
  account     FiduciaryAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  date        DateTime
  concept     String
  amount      Decimal  @db.Decimal(18, 2) // Positivo = ingreso, negativo = egreso
  balance     Decimal? @db.Decimal(18, 2) // Saldo después (opcional, para conciliación)
  reference   String?  // Referencia externa (conciliación manual/CSV)
  reconciled  Boolean  @default(false)
  reconciledWith String? // expenseId u otro id si se concilia con un gasto
  createdAt   DateTime @default(now())

  @@index([accountId])
  @@index([date])
  @@index([reconciled])
}

// --- Iteración 1: Documentación base ---
model ContractDocument {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  docType     String   // 'CONTRACT' | 'BUDGET_PLAN' | 'PROJECT_DRAFT' | 'SPECS' | etc.
  name        String
  documentUrl String?
  documentHash String?
  signedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  annexes     ContractAnnex[]

  @@index([trustId])
  @@index([docType])
}

model ContractAnnex {
  id        String   @id @default(uuid())
  contractDocumentId String
  contractDocument ContractDocument @relation(fields: [contractDocumentId], references: [id], onDelete: Cascade)
  annexType String?  // 'BUDGET_PLAN' | 'PROJECT_DRAFT' | 'SPECS'
  name      String
  documentUrl String?
  documentHash String?
  createdAt  DateTime @default(now())

  @@index([contractDocumentId])
}

// --- Iteración 1: Seguros (opcional) ---
model InsurancePolicy {
  id           String    @id @default(uuid())
  trustId      String
  trust        Trust     @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  policyType   String    // 'CONSTRUCTION' | 'LIABILITY' | 'ART_2071' | etc.
  insurer      String?
  policyNumber String?
  startDate    DateTime?
  endDate      DateTime?
  documentUrl String?
  documentHash String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([trustId])
  @@index([endDate])
}

// Checklist operativo de cumplimiento (Iteración 8)
model ChecklistItem {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  title       String
  description String?
  category    String?  // DOCUMENT | MILESTONE | COMPLIANCE
  completed   Boolean  @default(false)
  completedAt DateTime?
  dueDate    DateTime?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([trustId])
  @@index([completed])
}

// Glosario de conceptos por fideicomiso (Iteración 9): nombres genéricos parametrizables
model TrustConcept {
  id          String   @id @default(uuid())
  trustId     String
  trust       Trust    @relation(fields: [trustId], references: [trustId], onDelete: Cascade)
  conceptKey  String   // MILESTONE_PROGRESS, CONTRIBUTION, UNIT, etc.
  displayName String   // "Avance de obra", "Aporte", "Unidad funcional"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([trustId, conceptKey])
  @@index([trustId])
}

// Estados de Cuenta Mensuales según Cláusula Décima
model MonthlyStatement {
  id      String @id @default(uuid())
  trustId String
  trust   Trust  @relation(fields: [trustId], references: [trustId], onDelete: Cascade)

  // Período del estado de cuenta
  year  Int
  month Int // 1-12

  // Información del estado de cuenta
  statementDate DateTime @default(now()) // Fecha de emisión
  periodStart   DateTime // Inicio del período
  periodEnd     DateTime // Fin del período

  // Contenido
  summary      Json // Resumen del patrimonio, activos, pasivos
  assets       Json // Lista de activos al cierre del período
  transactions Json? // Transacciones del período

  // Documento
  documentUrl  String? // URL del PDF del estado de cuenta
  documentHash String? // Hash del documento para integridad

  // Aprobación del Comité Técnico / workflow (Iteración 7)
  status       String    @default("PENDING") // 'PENDING', 'PUBLISHED', 'APPROVED', 'OBSERVED', 'TACITLY_APPROVED', 'CLOSED'
  reportPhase  String?   @default("DRAFT")   // DRAFT | PUBLISHED | CLOSED
  submittedAt  DateTime  @default(now())
  reviewedAt   DateTime?
  reviewedBy   String? // Actor.id del miembro del Comité que revisó
  observations String? // Observaciones del Comité

  // Auto-aprobación tácita (10 días hábiles sin observaciones)
  tacitlyApprovedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([trustId, year, month])
  @@index([trustId])
  @@index([year, month])
  @@index([status])
  @@index([statementDate])
}

// Sesiones del Comité Técnico según Cláusula Sexta
model ComiteSession {
  id      String @id @default(uuid())
  trustId String
  trust   Trust  @relation(fields: [trustId], references: [trustId], onDelete: Cascade)

  sessionDate DateTime
  sessionType String // 'QUARTERLY', 'EXTRAORDINARY', 'SPECIAL'

  // Asistencia
  attendees String[] // Array de Actor.id
  quorum    Boolean  @default(false) // true si hay mayoría (2 de 3 miembros)

  // Agenda y decisiones
  agenda        Json? // Items de la agenda
  decisions     Json? // Decisiones tomadas
  approvedItems String[] // IDs de activos/presupuestos aprobados

  // Acta
  minutes     String? // Texto del acta
  minutesUrl  String? // URL del documento del acta
  minutesHash String? // Hash del documento para integridad

  // Estado
  status String @default("SCHEDULED") // 'SCHEDULED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'

  // Organización
  scheduledBy String? // Actor.id que agendó la reunión
  location    String? // Lugar de la reunión (presencial/virtual)
  meetingLink String? // Link para reunión virtual

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trustId])
  @@index([sessionDate])
  @@index([status])
  @@index([sessionType])
}

// Honorarios del Fiduciario según Cláusula Decima Segunda
model FiduciarioFee {
  id      String @id @default(uuid())
  trustId String
  trust   Trust? @relation(fields: [trustId], references: [trustId])

  // Tipos de honorarios según contrato
  studyFee        Decimal @default(5000) @db.Decimal(18, 2) // Por estudio y aceptación ($5,000 una vez)
  annualFee       Decimal @default(18000) @db.Decimal(18, 2) // Por manejo anual ($18,000)
  modificationFee Decimal @default(5000) @db.Decimal(18, 2) // Por modificación ($5,000)

  // Estado de pagos
  studyFeePaid   Boolean   @default(false)
  studyFeePaidAt DateTime?

  // Pagos mensuales del honorario anual (proporcional)
  monthlyPayments MonthlyFeePayment[]

  // Estado general
  allFeesPaid Boolean  @default(false) // true si todos los honorarios están pagos
  lastUpdated DateTime @default(now())

  @@unique([trustId])
  @@index([trustId])
}

// Pagos mensuales del honorario anual
model MonthlyFeePayment {
  id              String        @id @default(uuid())
  fiduciarioFeeId String
  fiduciarioFee   FiduciarioFee @relation(fields: [fiduciarioFeeId], references: [id], onDelete: Cascade)

  month  Int // Mes (1-12)
  year   Int // Año
  amount Decimal   @db.Decimal(18, 2) // Monto proporcional mensual
  paid   Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())

  @@unique([fiduciarioFeeId, year, month])
  @@index([fiduciarioFeeId])
}

// Relación entre Actores y Fideicomisos
// Permite que un usuario pertenezca a múltiples fideicomisos con diferentes roles
model ActorTrust {
  id      String @id @default(uuid())
  actorId String
  actor   Actor  @relation(fields: [actorId], references: [id], onDelete: Cascade)
  trustId String
  trust   Trust  @relation(fields: [trustId], references: [trustId], onDelete: Cascade)

  // Rol específico dentro del fideicomiso
  // Un mismo actor puede tener diferentes roles en diferentes fideicomisos
  roleInTrust ActorRole

  // Etiqueta por contrato (Iteración 10): FIDUCIANTE_A, FIDUCIANTE_B, BENEFICIARIO_A, etc.
  partyType String?

  // Fechas
  assignedAt DateTime  @default(now())
  revokedAt  DateTime?

  // Estado
  active Boolean @default(true)

  @@unique([actorId, trustId])
  @@index([actorId])
  @@index([trustId])
  @@index([active])
  @@index([roleInTrust])
}

// Logs de auditoría para acciones críticas
model AuditLog {
  id      String @id @default(uuid())
  actorId String // Actor que realizó la acción (puede ser UUID especial para sistema)
  actor   Actor? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  // Tipo de acción realizada
  action String // "ASSET_REGISTERED", "EXCEPTION_APPROVED", "EXCEPTION_REJECTED", "RULE_MODIFIED", "USER_CREATED", "USER_UPDATED", "USER_DELETED", "LOGIN", "LOGOUT", etc.

  // Entidad afectada
  entityType String? // "Asset", "Trust", "Actor", "Alert", etc.
  entityId   String? // ID de la entidad afectada

  // Contexto
  trustId     String? // Fideicomiso relacionado (si aplica)
  description String // Descripción legible de la acción

  // Detalles adicionales (JSON)
  metadata Json? // Información adicional específica de la acción

  // Información de seguridad
  ipAddress String? // IP desde donde se realizó la acción
  userAgent String? // User agent del navegador/cliente

  // Timestamp
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([trustId])
  @@index([createdAt])
}

// Votaciones de excepciones para activos que requieren consenso del Comité Técnico
model ExceptionVote {
  id      String @id @default(uuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  trustId String
  trust   Trust  @relation(fields: [trustId], references: [trustId], onDelete: Cascade)

  // Miembro del Comité Técnico que vota
  voterId String // Actor.id del miembro del Comité
  voter   Actor  @relation("ExceptionVotes", fields: [voterId], references: [id])

  // Voto
  vote   String // 'APPROVE' o 'REJECT'
  reason String? // Razón del voto (opcional)

  // Metadatos
  ipAddress String? // IP desde donde se votó
  userAgent String? // User agent del navegador/cliente

  createdAt DateTime @default(now())

  @@unique([assetId, voterId]) // Un miembro solo puede votar una vez por activo
  @@index([assetId])
  @@index([trustId])
  @@index([voterId])
  @@index([vote])
  @@index([createdAt])
}

// Plantillas para pre-llenar formularios de activos por tipo
model AssetTemplate {
  id String @id @default(uuid())

  // Tipo de activo al que aplica esta plantilla
  assetType AssetType

  // Fideicomiso específico (null = plantilla global)
  trustId String? // Si es null, es una plantilla global
  trust   Trust?  @relation(fields: [trustId], references: [trustId], onDelete: Cascade)

  // Nombre de la plantilla
  name        String // Ej: "Bono Gubernamental Estándar", "Préstamo Hipotecario Vivienda Social"
  description String? // Descripción opcional

  // Campos predefinidos (almacenados como JSON para flexibilidad)
  // Para GovernmentBond: { description, documentHash }
  // Para MortgageLoan: { description, mortgageData: { termYears, hasMortgageGuarantee, hasLifeInsurance, hasFireInsurance, interestRate } }
  // Para otros tipos: { description, ... }
  defaultFields Json // Campos por defecto según el tipo de activo

  // Metadatos
  isDefault Boolean @default(false) // Si es la plantilla por defecto para este tipo
  isActive  Boolean @default(true)

  // Creador de la plantilla
  createdBy String // Actor.id
  creator   Actor  @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assetType, trustId, name]) // No puede haber dos plantillas con el mismo nombre para el mismo tipo y fideicomiso
  @@index([assetType])
  @@index([trustId])
  @@index([isDefault])
  @@index([isActive])
  @@index([createdBy])
}
